########################################
# CVE-2022-30190 Vulnerability Fix #####
# cyBercy - 2022                   #####
########################################
#
# Make sure you have admin rights on the system where you run this script, and also on the remove machines
# If some machines are offline, you can run the script again after turning the machine on. The script is dynamically updating the source server list
#
# Please create manually these TXT files (path can be changed of course):



# This must contain all hostnames to check. Fill up manually before running the script!
$servers           = "C:\Scripts\secVuln\servers.txt"

# This will contain those servers, where the script successfully removed the regkey
$regKeyRemovedList = "C:\Scripts\secVuln\regkeyRemoved.txt"

# This will contain the systems, where the regkey was not there at all
$noRegKeyList      = "C:\Scripts\secVuln\noRegkey.txt"

# This will contain those systems which could not be pinged
$noPing            = "C:\Scripts\secVuln\noPing.txt"


$serverlist = gc $servers
Clear-Content $noPing

ForEach ($server in $serverlist) 

    {
    echo "Checking $server" 
    

    if(Test-Connection $server -Count 2 -ErrorAction SilentlyContinue)
    
    {

    $regKey = Invoke-Command -Computer $server {    Get-ItemProperty Registry::HKEY_CLASSES_ROOT\ms-msdt} -ErrorAction SilentlyContinue
    if ($regKey -eq $null)
        {
            echo "The ms-msdt regkey doesn't exist on $server"

            # Adding hostname to noRegkey.txt
            $server | Out-File $noRegKeyList -Append -Encoding UTF8

            # Removing hostname from servers.txt, because this system doesn't have this regkey
            Set-Content -Path $servers -Value (get-content -Path $servers | Select-String -Pattern $server -NotMatch)
        }
    else 
        {
            echo "The ms-msdt regkey exist and should be deleted"
            new-item \\$server\c$\Temp -ItemType dir -ErrorAction SilentlyContinue
            
            # Backup reg key
            echo "Backing up ms-msdt regkey..."
            Invoke-Command -ComputerName $server -ScriptBlock {reg export HKEY_CLASSES_ROOT\ms-msdt C:\Temp\ms-msdt.reg /y}

            # Remove reg key
            echo "Deleting ms-msdt regkey..."
            Invoke-Command -ComputerName $server -ScriptBlock {Remove-Item -Path Registry::HKEY_CLASSES_ROOT\ms-msdt -Recurse -Confirm:$false}

            # Adding hostname to regkeyRemoved.txt
            $server | Out-File $regKeyRemovedList -Append -Encoding UTF8

            # Removing hostname from servers.txt, because this system is done
            Set-Content -Path $servers -Value (get-content -Path $servers | Select-String -Pattern $server -NotMatch)
        }

        
        }

        else
        {
            write-host "$server is not responding/no ping" -ForegroundColor Yellow

            # Adding hostname to noPing.txt
            $server | Out-File $noPing  -Append -Encoding UTF8

        }
    
    echo "-----------------------------------------------------------"
    }